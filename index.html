<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progreso Vacacional</title>
    <style>
        /* Estilos Base y de Contenedor */
        body {
            font-family: Arial, sans-serif;
            background: #1c1c1c;            
            margin: 20px;
            padding: 20px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        }
        h2 {
            color: #dee2e6;              
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        .container {
            color: #dee2e6;              
            margin-bottom: 20px;
        }
        .result-box {
            background-color: #2a2a2a;        /* Fondo más oscuro para caja de resultados */
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
        }
        .progress-bar {
            width: 100%;
            height: 25px;
            background-color: #555; /* Fondo de la barra */
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
            border: 1px solid #ccc;
        }
        .progress-fill {
            height: 100%;
            background-color: #0267a1;
            text-align: center;
            line-height: 25px;
            color: white;
            font-weight: bold;
            transition: width 0.5s;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        input[type="date"] {
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #444; /* color de fondo del input */
            color: #dee2e6;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
        }
        button:hover {
            background-color: #007bff;
        }
        .color_label{
            color: #dee2e6;            
        }

        /* ESTILOS PARA EL DESPLEGABLE */
        .toggle-section {
            margin-top: 15px;
            cursor: pointer;
            color: #0056b3; /* Color llamativo para el botón */
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #555;
            padding-top: 10px;
            user-select: none; /* Evita que se seleccione el texto */
        }

        .toggle-section:hover {
            color: #ffffff;
        }

        .vacation-detail {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
            padding-top: 0;
        }
        
        .vacation-detail.open {
            max-height: 500px; /* Suficiente espacio para el contenido */
            padding-top: 10px;
        }
        
        #accumulation-dates {
            max-height: 200px;
            overflow-y: auto;
            background: #3a3a3a;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            line-height: 1.8; /* Aumentado para mejor visualización */
            font-size: 0.95rem;
            color: #e0e0e0;
            text-align: center;
            /* Importante: Revertimos white-space a normal si usamos <br> */
            white-space: normal;
        }
        
        /* ✨ ESTILO PARA RESALTAR EL PRÓXIMO DÍA ✨ */
        .next-accumulation {
            color: #e0e0e0; /* Color verde brillante para resaltar */
            font-weight: bold;
            background-color: #007bff70; /* Fondo suave para destacar la línea completa */
            padding: 2px 5px;
            border-radius: 3px;
            display: inline-block; /* Cambiado a inline-block para que el ancho se ajuste */
            width: 90%; /* Ajuste de ancho para centrar */
            margin: 0 auto; /* Centrar el bloque */
            border: 1px solid #ffffff;
        }
    </style>
</head>
<body>

    <h2>Vacaciones</h2>

    <div class="container">
        <label for="fecha-ingreso-input">Fecha de Ingreso:</label>
        <input type="date" id="fecha-ingreso-input" value="2022-04-19"> 
        <button onclick="calcularVacaciones()">Calcular Días</button>
    </div>

    <div id="resultados" class="result-box">
        Presiona "Calcular Días" para ver el progreso.
    </div>
    
    <div id="additional-info-container" class="result-box" style="margin-top: 15px; display: none;">
        <div class="toggle-section" onclick="toggleDetails()">
            + Información:
            <span id="toggle-icon">▼</span>
        </div>
        
        <div id="vacation-detail" class="vacation-detail">
            <div id="accumulation-dates"></div>
        </div>
    </div>
    
    <script>
        // Tablas de días de vacaciones iniciales (hasta el Año 5)
        const DIAS_PRE_2023 = { 
            1: 10, 2: 14, 3: 16, 4: 18, 5: 20
        };

        const DIAS_POST_2023 = { 
            1: 12, 2: 14, 3: 16, 4: 18, 5: 20
        };
        
        const FECHA_REFORMA = new Date(Date.UTC(2023, 0, 1));

        /* --- Funciones de lógica de vacaciones --- */

        function calcularDiasVacacionesFTL(anioServicioActual, diasBaseInicial) {
            if (anioServicioActual <= 5) return diasBaseInicial;
            const aniosQuinquenales = anioServicioActual - 5; 
            const bloquesQuinquenales = Math.floor(aniosQuinquenales / 5);
            const diasAdicionales = bloquesQuinquenales * 2;
            return diasBaseInicial + diasAdicionales;
        }

        /* --- Funciones de utilidad de fechas --- */

        function createUtcDate(year, month, day) {
            return new Date(Date.UTC(year, month, day));
        }
        
        function addDays(date, days) {
            const result = new Date(date);
            result.setUTCDate(result.getUTCDate() + days);
            return result;
        }

        function formatDateForDisplay(date) {
            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const year = date.getUTCFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function formatDateForList(date) {
            // Formato D/M/YYYY
            const day = date.getUTCDate();
            const month = date.getUTCMonth() + 1;
            const year = date.getUTCFullYear();
            return `${day}/${month}/${year}`;
        }

        function dateDiffInDays(date1, date2) {
            const msPerDay = 1000 * 60 * 60 * 24;
            return Math.floor((date1.getTime() - date2.getTime()) / msPerDay);
        }
        
        function determinarTablaDias(fechaIngreso) {
            return (fechaIngreso.getTime() >= FECHA_REFORMA.getTime()) ? DIAS_POST_2023 : DIAS_PRE_2023;
        }

        /**
         * Calcula, genera la lista y RESALTA la próxima fecha de acumulación.
         */
        function mostrarFechasAcumulacion(fechaInicioPeriodo, diasVacacionesTotales, diasTotalesPeriodo) {
            const hoyUtc = createUtcDate(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());
            const diasAcumularUnDia = diasTotalesPeriodo / diasVacacionesTotales;
            let outputHtml = '';
            let isNextFound = false;
            
            if (diasVacacionesTotales <= 0 || diasTotalesPeriodo <= 0) {
                document.getElementById("accumulation-dates").innerHTML = "No aplica acumulación de días.";
                return;
            }

            for (let i = 1; i <= diasVacacionesTotales; i++) {
                const diasParaAcumular = Math.round(diasAcumularUnDia * i);
                const fechaAcumulacion = addDays(fechaInicioPeriodo, diasParaAcumular);
                
                let className = '';
                if (!isNextFound && fechaAcumulacion.getTime() >= hoyUtc.getTime()) {
                    className = 'next-accumulation';
                    isNextFound = true;
                }
                
                // Generamos el <span> para la línea
                const lineContent = `<span class="${className}">${formatDateForList(fechaAcumulacion)} - Día ${i}°</span>`;

                // Añadimos el contenido y el salto de línea HTML (<br>)
                outputHtml += lineContent + '<br>';
            }
            
            document.getElementById("accumulation-dates").innerHTML = outputHtml;
        }

        /**
         * Maneja el despliegue del panel de información adicional.
         */
        function toggleDetails() {
            const detailDiv = document.getElementById('vacation-detail');
            const iconSpan = document.getElementById('toggle-icon');
            detailDiv.classList.toggle('open');
            iconSpan.innerText = detailDiv.classList.contains('open') ? '▲' : '▼';
        }


        /* --- Lógica principal de cálculo --- */

        function calcularVacaciones() {
            const inputDateString = document.getElementById('fecha-ingreso-input').value;

            if (!inputDateString) {
                document.getElementById('resultados').innerHTML = 'Por favor, introduce una fecha de ingreso válida.';
                document.getElementById('additional-info-container').style.display = 'none';
                return;
            }
            
            // 1. Inicialización de la Fecha de Ingreso y componentes (en UTC)
            const [year, month, day] = inputDateString.split('-').map(Number);
            const fechaIngreso = createUtcDate(year, month - 1, day); 
            
            const mesIngreso = month - 1; 
            const diaIngreso = day;
            
            const hoy = new Date();
            const hoyUtc = createUtcDate(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
            
            const diasPorAnio = determinarTablaDias(fechaIngreso);
            
            // 2. Determinar el año de servicio actual
            let aniosServicio = hoyUtc.getFullYear() - fechaIngreso.getFullYear();
            const aniversarioEsteAnio = createUtcDate(hoyUtc.getFullYear(), mesIngreso, diaIngreso);
            if (hoyUtc < aniversarioEsteAnio) aniosServicio -= 1;
            aniosServicio = Math.max(0, aniosServicio); 

            // 3. Definir fechas y días
            const anioServicioActual = aniosServicio + 1;
            const fechaAniversarioPasado = createUtcDate(fechaIngreso.getFullYear() + aniosServicio, mesIngreso, diaIngreso);
            const siguienteAniversario = createUtcDate(fechaIngreso.getFullYear() + anioServicioActual, mesIngreso, diaIngreso);
            const fechaFinPeriodo = new Date(siguienteAniversario.getTime() - (1000 * 60 * 60 * 24)); 

            // 4. Días de Vacaciones Totales
            let diasVacaciones;
            const diasBaseQuinquenal = diasPorAnio[5]; 
            if (anioServicioActual <= 5) {
                diasVacaciones = diasPorAnio[anioServicioActual];
            } else {
                diasVacaciones = calcularDiasVacacionesFTL(anioServicioActual, diasBaseQuinquenal);
            }

            // 5. Cálculos del Período
            const diasTranscurridosPeriodo = dateDiffInDays(hoyUtc, fechaAniversarioPasado);
            const diasTotalesPeriodo = dateDiffInDays(fechaFinPeriodo, fechaAniversarioPasado) + 1; 
            
            if (diasTotalesPeriodo <= 0) {
                document.getElementById('resultados').innerHTML = 'Error en el cálculo del periodo (días totales). Revisa la fecha de ingreso.';
                document.getElementById('additional-info-container').style.display = 'none';
                return;
            }

            // 6. Cálculo del progreso y pro-rateo
            const porcentajeProgreso = Math.min(1, diasTranscurridosPeriodo / diasTotalesPeriodo);
            const diasVacacionesGanados = diasVacaciones * porcentajeProgreso;
            const diasAcumularDia = (diasTotalesPeriodo / diasVacaciones);
            const diasPorDia = (diasVacaciones / diasTotalesPeriodo);
            
            // 7. Generación de la Barra de Progreso (HTML/CSS)
            const porcentajeFormato = (porcentajeProgreso * 100).toFixed(2);
            
            const progressBarHtml = `
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${porcentajeFormato}%;">
                        ${porcentajeFormato}%
                    </div>
                </div>
            `;
            
            // 8. Formato de Salida
            const formatoFechaDisplay = { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' };

            const resultadosHTML = `
                <p class="color_label"><strong>Fecha de Ingreso:</strong> ${fechaIngreso.toLocaleDateString('es-ES', formatoFechaDisplay)}</p>
                <p class="color_label"><strong>Año de antigüedad en curso:</strong> ${anioServicioActual}</p>
                <p class="color_label"><strong>Vacaciones para este año:</strong> <span style="font-size: 1.2em; color: #007bff;">${diasVacaciones} días</span></p>
                <hr style="border-top: 1px solid #555;">
                <p class="color_label"><strong>Período Actual:</strong> ${formatDateForDisplay(fechaAniversarioPasado)} a ${formatDateForDisplay(fechaFinPeriodo)}</p>
                <p class="color_label"><strong>Días Transcurridos:</strong> ${diasTranscurridosPeriodo} de ${diasTotalesPeriodo}</p>
                <p class="color_label"><strong>Día de vacacion generado cada:</strong> ${diasAcumularDia.toFixed(2)} días</p>
                <p class="color_label"><strong>Vacaciones actuales:</strong> <span style="font-size: 1.2em; color: #28a745;">${diasVacacionesGanados.toFixed(2)} días / ${diasVacaciones} días</span></p>
                <p class="color_label"><strong>Días generados por día:</strong> <span style="font-size: 1em; color: #007bff;"> ${diasPorDia.toFixed(4)} días</span></p>
                ${progressBarHtml}
            `;

            document.getElementById('resultados').innerHTML = resultadosHTML;
            document.getElementById('additional-info-container').style.display = 'block';

            // 9. Generación de Fechas de Acumulación
            mostrarFechasAcumulacion(fechaAniversarioPasado, diasVacaciones, diasTotalesPeriodo);
        }

        // Ejecutar al cargar la página con la fecha por defecto
        document.addEventListener('DOMContentLoaded', calcularVacaciones);

    </script>
</body>
</html>
